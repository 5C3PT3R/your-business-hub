<!DOCTYPE html>
<html>
<head>
    <title>Test Data Persistence - Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
        .output { background: #000; padding: 15px; margin: 10px 0; border: 1px solid #0f0; max-height: 500px; overflow-y: auto; }
        .error { color: #f00; }
        .success { color: #0f0; }
        .info { color: #0ff; }
        .warning { color: #ff0; }
        input { padding: 8px; font-family: monospace; width: 500px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üîç Data Persistence Test - Fixed</h1>

    <div>
        <h3>Step 1: Get Your Auth Token</h3>
        <p style="color: #ff0;">1. Open your app: <a href="https://upflo-lac.vercel.app/" target="_blank">https://upflo-lac.vercel.app/</a></p>
        <p style="color: #ff0;">2. Open Console (F12) and paste this:</p>
        <pre style="background: #000; padding: 10px; color: #0ff;">
const session = await (await fetch('https://pesqbkgfsfkqdquhilsv.supabase.co/auth/v1/user', {
    headers: { 'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlc3Fia2dmc2ZrcWRxdWhpbHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MDU3MTYsImV4cCI6MjA4MjA4MTcxNn0.SuRLVpP_k8vbSiZeTG_aJY9qiOPvRLiZo8amZNv2YTQ',
             'Authorization': 'Bearer ' + (await supabase.auth.getSession()).data.session?.access_token }
})).json();
console.log('Copy this token:', (await supabase.auth.getSession()).data.session?.access_token);
        </pre>
        <p style="color: #ff0;">3. Copy the token and paste it here:</p>
        <input type="text" id="token" placeholder="Paste your access token here" />
        <button onclick="setToken()">Set Token</button>
    </div>

    <hr style="border-color: #0f0; margin: 20px 0;">

    <div>
        <h3>Step 2: Run Tests</h3>
        <button onclick="testWorkspace()">1. Check Workspace</button>
        <button onclick="testAddLead()">2. Add Test Lead</button>
        <button onclick="testFetchLeads()">3. Fetch Leads</button>
        <button onclick="testAddContact()">4. Add Test Contact</button>
        <button onclick="testFetchContacts()">5. Fetch Contacts</button>
        <button onclick="testPolicies()">6. Test Policies</button>
        <button onclick="clearOutput()">Clear</button>
    </div>
    <div class="output" id="output"></div>

    <script>
        const { createClient } = supabase;
        let client = createClient(
            'https://pesqbkgfsfkqdquhilsv.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlc3Fia2dmc2ZrcWRxdWhpbHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MDU3MTYsImV4cCI6MjA4MjA4MTcxNn0.SuRLVpP_k8vbSiZeTG_aJY9qiOPvRLiZo8amZNv2YTQ'
        );

        let userToken = null;

        function setToken() {
            userToken = document.getElementById('token').value.trim();
            if (!userToken) {
                log('ERROR: Please paste your token first!', 'error');
                return;
            }
            log('‚úì Token set! You can now run tests.', 'success');
        }

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        async function makeAuthRequest(path, options = {}) {
            if (!userToken) {
                throw new Error('No token set. Please set your token first!');
            }

            const response = await fetch(`https://pesqbkgfsfkqdquhilsv.supabase.co${path}`, {
                ...options,
                headers: {
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlc3Fia2dmc2ZrcWRxdWhpbHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MDU3MTYsImV4cCI6MjA4MjA4MTcxNn0.SuRLVpP_k8vbSiZeTG_aJY9qiOPvRLiZo8amZNv2YTQ',
                    'Authorization': `Bearer ${userToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers,
                },
            });

            return response.json();
        }

        async function testWorkspace() {
            log('=== TESTING WORKSPACE ===', 'info');

            try {
                const user = await makeAuthRequest('/auth/v1/user');

                if (user.error || !user.id) {
                    log('ERROR: Not logged in or invalid token!', 'error');
                    log('Error: ' + (user.error || 'No user ID'), 'error');
                    return;
                }

                log(`‚úì Logged in as: ${user.email}`, 'success');
                log(`‚úì User ID: ${user.id}`, 'success');

                // Check workspaces
                const workspaces = await makeAuthRequest(
                    `/rest/v1/workspaces?owner_id=eq.${user.id}&select=*`
                );

                if (workspaces.error) {
                    log(`ERROR fetching workspaces: ${workspaces.error.message}`, 'error');
                    return;
                }

                log(`‚úì Found ${workspaces.length} workspaces`, 'success');
                workspaces.forEach((ws, i) => {
                    log(`  ${i + 1}. ${ws.name} (ID: ${ws.id})`, 'info');
                });

                // Check localStorage
                const savedWsId = localStorage.getItem('current_workspace_id');
                log(`‚úì localStorage workspace_id: ${savedWsId || 'NOT SET'}`, savedWsId ? 'success' : 'warning');

                // Check workspace_members
                const members = await makeAuthRequest(
                    `/rest/v1/workspace_members?user_id=eq.${user.id}&select=*`
                );

                log(`‚úì Member of ${members.length} workspaces`, 'success');
                members.forEach(m => {
                    log(`  - Workspace: ${m.workspace_id}, Role: ${m.role}`, 'info');
                });

                return { user, workspace: workspaces[0] };
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        async function testAddLead() {
            log('=== ADDING TEST LEAD ===', 'info');

            try {
                const user = await makeAuthRequest('/auth/v1/user');
                if (!user.id) {
                    log('ERROR: Not logged in!', 'error');
                    return;
                }

                const workspaces = await makeAuthRequest(
                    `/rest/v1/workspaces?owner_id=eq.${user.id}&select=*&limit=1`
                );

                if (!workspaces || workspaces.length === 0) {
                    log('ERROR: No workspace found!', 'error');
                    return;
                }

                const workspace = workspaces[0];
                log(`Using workspace: ${workspace.name} (${workspace.id})`, 'info');

                const leadData = {
                    name: `Test Lead ${Date.now()}`,
                    email: 'test@example.com',
                    phone: '+1234567890',
                    company: 'Test Corp',
                    source: 'test',
                    status: 'new',
                    value: 1000,
                    user_id: user.id,
                    workspace_id: workspace.id
                };

                log(`Inserting lead...`, 'info');

                const result = await makeAuthRequest('/rest/v1/leads', {
                    method: 'POST',
                    body: JSON.stringify(leadData),
                    headers: {
                        'Prefer': 'return=representation'
                    }
                });

                if (result.error || (Array.isArray(result) && result.length === 0)) {
                    log(`ERROR: ${result.error?.message || 'Failed to insert'}`, 'error');
                    log(`Details: ${JSON.stringify(result, null, 2)}`, 'error');
                    return;
                }

                const data = Array.isArray(result) ? result[0] : result;
                log(`‚úì Lead created successfully!`, 'success');
                log(`  ID: ${data.id}`, 'success');
                log(`  Name: ${data.name}`, 'success');
                log(`  Workspace: ${data.workspace_id}`, 'success');
                log(`  User: ${data.user_id}`, 'success');
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        async function testFetchLeads() {
            log('=== FETCHING LEADS ===', 'info');

            try {
                const user = await makeAuthRequest('/auth/v1/user');
                if (!user.id) {
                    log('ERROR: Not logged in!', 'error');
                    return;
                }

                const workspaces = await makeAuthRequest(
                    `/rest/v1/workspaces?owner_id=eq.${user.id}&select=*&limit=1`
                );

                if (!workspaces || workspaces.length === 0) {
                    log('ERROR: No workspace found!', 'error');
                    return;
                }

                const workspace = workspaces[0];
                log(`Fetching leads for workspace: ${workspace.id}`, 'info');

                const leads = await makeAuthRequest(
                    `/rest/v1/leads?workspace_id=eq.${workspace.id}&order=created_at.desc&select=*`
                );

                if (leads.error) {
                    log(`ERROR: ${leads.error.message}`, 'error');
                    return;
                }

                log(`‚úì Found ${leads.length} leads`, 'success');
                leads.forEach((lead, i) => {
                    log(`  ${i + 1}. ${lead.name} - ${lead.email} (ID: ${lead.id})`, 'info');
                    log(`     Workspace: ${lead.workspace_id}, User: ${lead.user_id}`, 'info');
                });
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        async function testAddContact() {
            log('=== ADDING TEST CONTACT ===', 'info');

            try {
                const user = await makeAuthRequest('/auth/v1/user');
                if (!user.id) {
                    log('ERROR: Not logged in!', 'error');
                    return;
                }

                const workspaces = await makeAuthRequest(
                    `/rest/v1/workspaces?owner_id=eq.${user.id}&select=*&limit=1`
                );

                if (!workspaces || workspaces.length === 0) {
                    log('ERROR: No workspace found!', 'error');
                    return;
                }

                const workspace = workspaces[0];
                log(`Using workspace: ${workspace.name} (${workspace.id})`, 'info');

                const contactData = {
                    name: `Test Contact ${Date.now()}`,
                    email: 'contact@example.com',
                    phone: '+1234567890',
                    company: 'Test Corp',
                    position: 'Manager',
                    status: 'active',
                    user_id: user.id,
                    workspace_id: workspace.id
                };

                log(`Inserting contact...`, 'info');

                const result = await makeAuthRequest('/rest/v1/contacts', {
                    method: 'POST',
                    body: JSON.stringify(contactData),
                    headers: {
                        'Prefer': 'return=representation'
                    }
                });

                if (result.error || (Array.isArray(result) && result.length === 0)) {
                    log(`ERROR: ${result.error?.message || 'Failed to insert'}`, 'error');
                    log(`Details: ${JSON.stringify(result, null, 2)}`, 'error');
                    return;
                }

                const data = Array.isArray(result) ? result[0] : result;
                log(`‚úì Contact created successfully!`, 'success');
                log(`  ID: ${data.id}`, 'success');
                log(`  Name: ${data.name}`, 'success');
                log(`  Workspace: ${data.workspace_id}`, 'success');
                log(`  User: ${data.user_id}`, 'success');
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        async function testFetchContacts() {
            log('=== FETCHING CONTACTS ===', 'info');

            try {
                const user = await makeAuthRequest('/auth/v1/user');
                if (!user.id) {
                    log('ERROR: Not logged in!', 'error');
                    return;
                }

                const workspaces = await makeAuthRequest(
                    `/rest/v1/workspaces?owner_id=eq.${user.id}&select=*&limit=1`
                );

                if (!workspaces || workspaces.length === 0) {
                    log('ERROR: No workspace found!', 'error');
                    return;
                }

                const workspace = workspaces[0];
                log(`Fetching contacts for workspace: ${workspace.id}`, 'info');

                const contacts = await makeAuthRequest(
                    `/rest/v1/contacts?workspace_id=eq.${workspace.id}&order=created_at.desc&select=*`
                );

                if (contacts.error) {
                    log(`ERROR: ${contacts.error.message}`, 'error');
                    return;
                }

                log(`‚úì Found ${contacts.length} contacts`, 'success');
                contacts.forEach((contact, i) => {
                    log(`  ${i + 1}. ${contact.name} - ${contact.email} (ID: ${contact.id})`, 'info');
                    log(`     Workspace: ${contact.workspace_id}, User: ${contact.user_id}`, 'info');
                });
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        async function testPolicies() {
            log('=== TESTING RLS POLICIES ===', 'info');

            try {
                const user = await makeAuthRequest('/auth/v1/user');
                if (!user.id) {
                    log('ERROR: Not logged in!', 'error');
                    return;
                }

                log(`Testing as user: ${user.id}`, 'info');

                // Test leads
                try {
                    const leads = await makeAuthRequest('/rest/v1/leads?select=count');
                    log(`‚úì SELECT leads OK (count: ${leads[0]?.count || 0})`, 'success');
                } catch (e) {
                    log(`‚úó SELECT leads FAILED: ${e.message}`, 'error');
                }

                // Test contacts
                try {
                    const contacts = await makeAuthRequest('/rest/v1/contacts?select=count');
                    log(`‚úì SELECT contacts OK (count: ${contacts[0]?.count || 0})`, 'success');
                } catch (e) {
                    log(`‚úó SELECT contacts FAILED: ${e.message}`, 'error');
                }

                // Test deals
                try {
                    const deals = await makeAuthRequest('/rest/v1/deals?select=count');
                    log(`‚úì SELECT deals OK (count: ${deals[0]?.count || 0})`, 'success');
                } catch (e) {
                    log(`‚úó SELECT deals FAILED: ${e.message}`, 'error');
                }

                // Test tasks
                try {
                    const tasks = await makeAuthRequest('/rest/v1/tasks?select=count');
                    log(`‚úì SELECT tasks OK (count: ${tasks[0]?.count || 0})`, 'success');
                } catch (e) {
                    log(`‚úó SELECT tasks FAILED: ${e.message}`, 'error');
                }
            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        window.onload = () => {
            log('=== Test Tool Loaded ===', 'success');
            log('Please follow Step 1 to get your token, then run tests in Step 2', 'info');
        };
    </script>
</body>
</html>
